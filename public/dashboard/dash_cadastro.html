<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dash.css">
    <link rel="stylesheet" href="../css/dash_cadastro.css">
    <link rel="stylesheet" href="../css/dash_prin-filt.css" />
    <script src="../js/sessao.js"></script> 
    <title>Dashboard Cadastros</title>
</head>
<body onload="listarFuncionarios(sessionStorage.FKCODIGO_INSTITUICAO), exibirDadosLogin()">
    
        <section class="dashboard">
            <div class="menu">
                <div class="logo">
                    <img src="../assets/logo.png" alt="logo infinity" >
                    <h2 style="font-weight: lighter;">INFINITY <b style="font-weight: normal;">SOLUTIONS</b></h2>
                </div>
                <div class="opcoes">
                    <a href="./dashboard.html">PRINCIPAL</a>
                    <a href="./filtrada.html">FILTRADA</a>
                    <a href="#">RELATÓRIOS</a>
                    <a href="">CADASTRO</a>
                    <span class="help">
                        <a href="#">CONFIGURAÇÕES</a>
                        <a href="#">SUPORTE</a>
                    </span>
                    <a onclick="sair()">ENCERRAR SESSÃO</a>
                </div>
            </div>

            <div class="container">
            <div class="navdash">
                <span class="titulo">
                    CADASTRAR <b>FUNCIONÁRIOS</b>
                </span>
                <div class="navdash-menu">
                    <img src="../assets/tomas.png" alt="" class="img-navbar-menu">
                    <span id="nome_user_menu"></span>
                    <button class="btn-navbar-menu"><img src="../assets/downArrow.png" alt=""></button>
                </div>
            </div>

            <div class="corpo-dash">
                <div class="divisao form">
                    <span class="titulo-corpo">NOVO FUNCIONÁRIO:</span>
                    <div class=" bloco form-cad-users">

                        <span class="label-cad-user">NOME:</span>
                        <input type="text" name="" id="nome_funcionario" class="inpt-cad-user">

                        <span class="label-cad-user">CPF:</span>
                        <input type="text" name="" id="cpf_funcionario" class="inpt-cad-user">

                        <span class="label-cad-user">CARGO:</span>
                        <input type="text" name="" id="cargo_funcionario" class="inpt-cad-user">

                        <div class="secao">
                            <span class="label-cad-user">CODIGO ACESSO:</span>
                            <span class="label-cad-user" id="codigo_acesso"></span>
                        </div>

                        <div class="secao">
                            <button class="btn-cad-user" onclick="cadastrar()">CADASTRAR</button>
                            <button class="btn-cad-user difer" onclick="excluir()">EXCLUIR</button>
                        </div>
                    </div>
                </div>

                <div class="divisao lista">
                    <span class="titulo-corpo">CADASTROS REALIZADOS:</span>
                    <div class="bloco lista-users" id="lista_users">
                      

                    </div>
                </div>
            </div>

        </div>
        </section>
    
        
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>
</html>

<script>

    function excluir(){
        let codigoVar = (codigo_acesso.innerText).trim();

        if(codigoVar != undefined
        ){
            fetch("/usuarios/buscarUsuariosCodigo", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            codigoFuncionarioServer: codigoVar
        })
    })
    .then(function (resposta) {
        console.log("ESTOU NO THEN DO excluir()!");
        if (resposta.ok) {
            alert("Usuário Deletado com Sucesso!");
            listarFuncionarios(sessionStorage.FKCODIGO_INSTITUICAO);
            nome_funcionario.value = '';
            cpf_funcionario.value = '';
            cargo_funcionario.value = '';
            codigo_acesso.innerHTML = '';
        } else {
            console.log("Houve um erro ao tentar excluir funcionario!");
            alert("Houve um erro ao tentar excluir funcionario!");
            throw new Error("Erro na resposta do servidor");
        }
    })
    .catch(function (erro) {
        console.log(erro);
    });

    
    }
    return false;
}
    
    function editarFuncionario(nome, cargo, codigo, cpf){
        nome_funcionario.value = nome;
        cpf_funcionario.value = cpf;
        cargo_funcionario.value = cargo;
        codigo_acesso.innerHTML = codigo;
    }

    function listarFuncionarios(codigoInstituicao){
        document.getElementById("lista_users").innerHTML = '';
        fetch("/usuarios/buscarUsuariosUnidade", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            codigoInstituicaoServer: codigoInstituicao
        })
    })
    .then(function (resposta) {
        console.log("ESTOU NO THEN DO entrar()!");

        if (resposta.ok) {
            return resposta.json(); 
        } else {
            console.log("Houve um erro ao tentar listar os funcionarios!");
            alert("Houve um erro ao tentar listar os funcionarios!");
            throw new Error("Erro na resposta do servidor");
        }
    })
    .then(function (dados) {
        console.log(dados);

        dados.forEach(item => {

            if(sessionStorage.STATUS_FUNCIONARIO == "master"){
                if(item.status_funcionario == "master" ){

                    document.getElementById("lista_users").innerHTML += `
                            <div class="divisor">
                                <span class="nome-user">${item.nome_funcionario}</span>
                                <ion-icon name="create-outline" class="bloqueio"></ion-icon>
                            </div>
                            <span class="cargo-user">${item.cargo_funcionario}</span>
                            <hr>`;
                    }else if(item.status_funcionario == "ativo" || item.status_funcionario == "aguardando verificação"){

                        document.getElementById("lista_users").innerHTML += `
                            <div class="divisor">
                                <span class="nome-user">${item.nome_funcionario}</span>
                                <ion-icon name="create-outline" onclick="editarFuncionario('${item.nome_funcionario}', '${item.cargo_funcionario}', '${item.codigo_funcionario}', '${item.cpf_funcionario}')"></ion-icon>
                            </div>
                            <span class="cargo-user">${item.cargo_funcionario}</span>
                            <hr>`;

                    }
            }else{
                document.getElementById("lista_users").innerHTML += `
                            <div class="divisor">
                                <span class="nome-user">${item.nome_funcionario}</span>
                                <ion-icon name="create-outline" class="bloqueio"></ion-icon>
                            </div>
                            <span class="cargo-user">${item.cargo_funcionario}</span>
                            <hr>`;
            }


        });
    })
    .catch(function (erro) {
        console.log(erro);
    });

    return false;

    }

    function sair() {
        limparSessao();
    }

    

    function gerarCodigo() {
        const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let codigo = '';
        for (let i = 0; i < 6; i++) {
            const randomIndex = Math.floor(Math.random() * caracteres.length);
            codigo += caracteres[randomIndex];
        }
        return codigo;
    }

    function cadastrar() {

        let nomeVar = (nome_funcionario.value).trim();
        let cpfVar = (cpf_funcionario.value).trim();
        let cargoVar = (cargo_funcionario.value).trim();
        let codigoAcessoVar = gerarCodigo();

        if(nomeVar != '' &&
            cargoVar != '' &&
            cpfVar != '' 
        ){
            fetch("/usuarios/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                // crie um atributo que recebe o valor recuperado aqui
                // Agora vá para o arquivo routes/usuario.js
                nomeServer: nomeVar,
                cpfServer: cpfVar,
                cargoServer: cargoVar,
                codigoAcessoServer: codigoAcessoVar
            }),
            })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    alert("Cadastro realizado com sucesso!");

                    codigo_acesso.innerHTML = codigoAcessoVar;

                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                    alert("Houve um erro ao tentar realizar o cadastro!");
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

        }else{
            alert("Dados inválidos");
        }
        
        return false;
    }

</script>