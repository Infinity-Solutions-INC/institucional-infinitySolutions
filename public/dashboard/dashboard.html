<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/dash.css" />
    <link rel="stylesheet" href="../css/dash_prin-filt.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/sessao.js"></script>
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>
    <link rel="icon" href="../assets/logo.png" />
    <title>Dashboard Principal</title>
  </head>
  <body>
    <section class="dashboard">
      <div class="modal1 modal">
        <div class="contentmodal" id="modal_curso">
          <div class="content-usuario">
            <div class="inf-modal">
              <span class="titulo-modal">
                <h1>REGISTRAR CURSO</h1>
              </span>
              <span class="input-user nome">
                NOME DO CURSO: <br />
                <input type="text" id="nome_curso" />
              </span>
              <span class="input-user ano">
                ANO DO CURSO: <br />
                <input type="number" id="ano_curso" />
              </span>
              <div class="botoes-modal">
                <button id="registrar_curso" onclick="registrarCurso()">
                  REGISTRAR
                </button>
                <button onclick="deletarCurso()">EXCLUIR</button>
              </div>
            </div>
            <div class="cursos-modal">
              <span
                class="close-modal"
                onclick="sumirModal()"
                style="cursor: pointer"
              >
                X
              </span>
              <span id="titulo-lista"> CURSOS REGISTRADOS </span>
              <div class="bloco lista-cursos" id="lista-cursos"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="menu">
        <div class="logo">
          <img src="../assets/logo.png" alt="logo infinity" />
          <h2 style="font-weight: lighter">
            INFINITY <b style="font-weight: normal">SOLUTIONS</b>
          </h2>
        </div>
        <div class="opcoes">
          <a href="./dashboard.html">PRINCIPAL</a>
          <a href="./filtrada.html">FILTRADA</a>
          <a href="./relatorio_ia.html">RELATÓRIOS</a>
          <a href="./dash_cadastro.html">CADASTRO</a>
          <a href="./cad_turmas.html">TURMAS</a>
          <span class="help">
            <a href="./edit_perfil.html">CONFIGURAÇÕES</a>
            <a href="#">SUPORTE</a>
          </span>
          <a onclick="sair()">ENCERRAR SESSÃO</a>
        </div>
      </div>
      <div class="content">
        <div class="navdash">
          <span class="titulo"> DASHBOARD <b>PRINCIPAL</b> </span>
          <div class="navdash-menu">
            <img src="../assets/tomas.png" alt="" class="img-navbar-menu" />
            <span>Tomás Galleno</span>
            <button class="btn-navbar-menu">
              <img src="../assets/downArrow.png" alt="" />
            </button>
          </div>
        </div>

        <div class="container">
          <div class="kpis">
            <h2>KPIs</h2>
            <div class="box-kpi" style="margin-top: -15px">
              <span class="titulo-kpi"> CURSO COM MAIOR EVASÃO </span>
              <span class="dado-kpi">
                <p id="curso_maior_evasao"></p>
              </span>
              <span class="legenda-kpi"> X% DOS ALUNOS TOTAIS </span>
            </div>
            <div class="box-kpi">
              <span class="titulo-kpi"> TURNO COM MAIOR EVASÃO </span>
              <span class="dado-kpi"> XXX </span>
              <span class="legenda-kpi">
                X% DAS MATRICULAS SÃO NESSE TURNO
              </span>
            </div>
            <div class="box-kpi">
              <span class="titulo-kpi"> MODALIDADE COM MAIOR EVASÃO </span>
              <span class="dado-kpi"> XXX </span>
              <span class="legenda-kpi">
                X% DAS MATRICULAS SÃO NESSE TURNO
              </span>
            </div>
          </div>
          <div class="ranking">
            <div class="cabecalho">
              <h2>LISTA DE CURSOS</h2>
              <ion-icon
                name="ellipsis-horizontal-outline"
                id="edit-cursos"
                onclick="cadastroCurso()"
              ></ion-icon>
            </div>
            <div class="tabela-ev" style="margin-top: -5px">
              <div class="dados-curso">
                <span class="tb-curso" id="tb-cursos">
                  <b>CURSO</b>
                  <span id="bloco-cursos"> </span>
                </span>
                <span class="tb-alunos">
                  <b>ALUNOS</b>
                  <span id="bloco-alunos"> </span>
                </span>
              </div>
            </div>
          </div>
          <div class="graficos">
            <div class="superior">
              <h2>MODALIDADE</h2>
              <div class="grafico">
                <span class="chartInside">
                  <canvas
                    width="100"
                    height="100"
                    id="graficoModalidade"
                  ></canvas>
                </span>
              </div>
            </div>
            <div class="superior">
              <h2>TURNO</h2>
              <div class="grafico">
                <span class="chartInside">
                  <canvas id="graficoTurno"></canvas>
                </span>
              </div>
            </div>
            <div class="inferior">
              <h2>MOTIVOS</h2>
              <div class="grafico">
                <span class="chartInside">
                  <canvas id="graficoMotivos"></canvas>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </body>
</html>

<script>
  let cursoEmEdicao = null;

  const modais = document.querySelectorAll(".modal");
  modais.forEach((modal) => (modal.style.display = "none"));

  function cadastroCurso() {
    const modalSelecionado = document.querySelector(`.modal1`);
    if (modalSelecionado) {
      modalSelecionado.style.display = "block";
    }
  }

  function sumirModal() {
    document.getElementById("nome_curso").value = "";
    document.getElementById("ano_curso").value = "";
    document.getElementById("registrar_curso").innerHTML = "REGISTRAR";
    cursoEmEdicao = null;
    const modais = document.querySelectorAll(".modal");
    modais.forEach((modal) => (modal.style.display = "none"));
  }

  function buscarCursos() {
    const idInstituicao = sessionStorage.FKCODIGO_INSTITUICAO;

    if (!idInstituicao) {
      console.error("ID da instituição não definida");
      return;
    }

    fetch(`/cursos/buscarCursosPorUnidade/${idInstituicao}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then(function (resposta) {
        if (resposta.ok) {
          return resposta.json();
        } else {
          throw new Error("Houve um erro ao tentar trazer o resultado");
        }
      })
      .then(function (data) {
        if (data.length === 0) {
          console.warn("Nenhum resultado encontrado");
          return;
        }

        /* funçãozinha pra listar os cursos e alunos no front */
        listarCursos(data);
        console.log(data);

        /* buscar alunos dos cursos*/

        fetch(`/turmas/buscarAlunosPorCurso/${idInstituicao}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then(function (resposta) {
            if (resposta.ok) {
              return resposta.json();
            } else {
              throw new Error("Houve um erro ao tentar trazer o resultado");
            }
          })
          .then(function (data) {
            if (data.length === 0) {
              console.warn("Nenhum resultado encontrado");
              return;
            }

            /* funçãozinha pra listar os cursos e alunos no front */
            console.log(data);
            listarAlunos(data);
          })
          .catch(function (erro) {
            console.error(`#ERRO: ${erro}`);
          });
      })
      .catch(function (erro) {
        console.error(`#ERRO: ${erro}`);
      });
  }

  buscarCursos();

  function listarCursos(cursosListados) {
    const listaCursos = document.getElementById("lista-cursos");
    listaCursos.innerHTML = "";

    cursosListados.forEach((item) => {
      // if(item.ano_curso != null) {
      listaCursos.innerHTML += `
             <div class="divisor-curso">
                 <span class="nome-curso">${item.nome_curso}</span>
                 <ion-icon name="create-outline" onclick="editarCurso('${item.codigo_curso}', '${item.nome_curso}', '${item.ano_curso}')"></ion-icon>
             </div>
             <hr id="linha-curso">`;
      // }
    });
  }


  function listarAlunos(cursosListados) {
  const rankingCursos = document.getElementById("bloco-cursos");
  const listaAlunos = document.getElementById("bloco-alunos");
  rankingCursos.innerHTML = "";
  listaAlunos.innerHTML = "";

  // Ordena os cursos que possuem turmas pela maior evasão
  cursosListados.sort((a, b) => parseInt(b.total_evasao) - parseInt(a.total_evasao));

  document.getElementById("curso_maior_evasao").innerHTML = cursosListados[0].nome_curso;


  cursosListados.forEach((item) => {
    const evasaoAtual = parseInt(item.total_evasao);
    const evasaoAnterior = parseInt(item.evasao_anterior);
    let simboloEvasao, corSimbolo;

    if (evasaoAtual > evasaoAnterior) {
      simboloEvasao = "&#9650;";
      corSimbolo = "red";
    } else if (evasaoAtual < evasaoAnterior) {
      simboloEvasao = "&#9660";
      corSimbolo = "green";
    } else {
      simboloEvasao = "=";
      corSimbolo = "gray";
    }


    rankingCursos.innerHTML += `
      <p class="dados-curso">${item.nome_curso}</p>
    `;

    listaAlunos.innerHTML += `
      <p class="dados-evasao">${evasaoAtual}
      <span style="color: ${corSimbolo};">${simboloEvasao}</span>  
      </p>
    `;
  });
}



  function editarCurso(idCurso, nome, ano) {
    document.getElementById("registrar_curso").innerHTML = "ATUALIZAR";
    cursoEmEdicao = idCurso;
    nome_curso.value = nome;
    ano_curso.value = ano;
    console.log(`curso em edição: ${cursoEmEdicao}, ${nome}, ${ano}`);
  }

  function registrarCurso() {
    let cursoVar = nome_curso.value.trim().toLowerCase();
    let anoVar = ano_curso.value.trim();
    let idInstituicao = sessionStorage.FKCODIGO_INSTITUICAO;

    if (!idInstituicao) {
      alert("ID da instituição não encontrado!");
      return;
    }

    if (cursoVar !== "" && anoVar !== "") {
      if (cursoEmEdicao !== null) {
        atualizarCurso(cursoEmEdicao, cursoVar, anoVar, idInstituicao);
      } else {
        // Se não for edição, faz o insert
        fetch(`/cursos/cadastrarCurso`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            nomeCursoServer: cursoVar,
            anoCursoServer: anoVar,
            idInstituicaoServer: idInstituicao,
          }),
        })
          .then(function (resposta) {
            if (resposta.ok) {
              return resposta.json();
            } else {
              throw new Error("Houve um erro ao registrar o curso!");
            }
          })
          .then(function (data) {
            document.getElementById("nome_curso").value = "";
            document.getElementById("ano_curso").value = "";
            cursoEmEdicao = null;
            alert("Curso registrado com sucesso!");
            buscarCursos();
          })
          .catch(function (erro) {
            console.log(`#ERRO: ${erro.message}`);
            alert(erro.message);
          });
      }
    } else {
      alert("Dados inválidos");
    }

    return false;
  }

  function atualizarCurso(idCurso, nomeCurso, anoCurso, idInstituicao) {
    fetch(`/cursos/editarCurso/${idCurso}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        nomeCursoServer: nomeCurso,
        anoCursoServer: anoCurso,
        idInstituicaoServer: idInstituicao,
      }),
    })
      .then((resposta) => {
        if (resposta.ok) {
          return resposta.json();
        } else {
          throw new Error("Houve um erro ao atualizar o curso!");
        }
      })
      .then((data) => {
        document.getElementById("registrar_curso").innerHTML = "REGISTRAR";
        document.getElementById("nome_curso").value = "";
        document.getElementById("ano_curso").value = "";
        cursoEmEdicao = null;
        alert("Curso atualizado com sucesso!");
        buscarCursos();
      })
      .catch((erro) => {
        console.log(`#ERRO: ${erro.message}`);
        alert(erro.message);
      });
  }

  function deletarCurso() {
    let idInstituicao = sessionStorage.FKCODIGO_INSTITUICAO;

    if (!idInstituicao || !cursoEmEdicao) {
      alert("ID da instituição ou ID do curso inválido.");
      return;
    }

    fetch(`/cursos/deletarCurso`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idCursoServer: cursoEmEdicao,
        idInstituicaoServer: idInstituicao,
      }),
    })
      .then((resposta) => {
        if (resposta.ok) {
          return resposta.json();
        } else {
          throw new Error("Houve um erro ao deletar o curso!");
        }
      })
      .then((data) => {
        document.getElementById("registrar_curso").innerHTML = "REGISTRAR";
        document.getElementById("nome_curso").value = "";
        document.getElementById("ano_curso").value = "";
        cursoEmEdicao = null;
        buscarCursos();
        alert("Curso deletado com sucesso!");
      })
      .catch((erro) => {
        console.log(`#ERRO: ${erro.message}`);
        alert(erro.message);
      });
  }

  function sair() {
    limparSessao();
  }

  // Gráfico de Barras (Modalidade)
  const ctxModalidade = document
    .getElementById("graficoModalidade")
    .getContext("2d");
  const graficoModalidade = new Chart(ctxModalidade, {
    type: "bar",
    data: {
      labels: ["Online", "Presencial"],
      datasets: [
        {
          label: "Matriculas (%)",
          data: [75, 25],
          backgroundColor: ["#270091", "#3F00EC"],
        },
      ],
    },
    options: {
      scales: {
        y: {
          ticks: {
            display: false,
          },
          grid: {
            display: false,
          },
        },
        x: {
          ticks: {
            color: "#ffffff",
          },
        },
      },
      plugins: {
        legend: {
          display: false,
        },
      },
    },
  });

  // Gráfico Donut (Turno)
  const ctxTurno = document.getElementById("graficoTurno").getContext("2d");
  const graficoTurno = new Chart(ctxTurno, {
    type: "doughnut",
    data: {
      labels: ["Matutino", "Vespertino", "Noturno"],
      datasets: [
        {
          label: "Matriculas (%)",
          data: [10, 30, 60],
          backgroundColor: ["#270091", "#3F00EC", "#020272"],
          borderWidth: 0,
        },
      ],
    },
    options: {
      plugins: {
        legend: {
          labels: {
            color: "#ffffff",
          },
        },
      },
    },
  });

  // Gráfico de Linha (Motivos)
  const ctxMotivos = document.getElementById("graficoMotivos").getContext("2d");
  const graficoMotivos = new Chart(ctxMotivos, {
    type: "line",
    data: {
      labels: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho"],
      datasets: [
        {
          label: "Financeiro",
          data: [10, 15, 5, 8, 6, 9],
          borderColor: "#020272",
          backgroundColor: "#020272",
          fill: false,
        },
        {
          label: "Desmotivação",
          data: [7, 9, 12, 5, 6, 10],
          borderColor: "#270091",
          backgroundColor: "#270091",
          fill: false,
        },
        {
          label: "Dificuldade",
          data: [8, 6, 7, 13, 9, 11],
          borderColor: "#3F00EC",
          backgroundColor: "#3F00EC",
          fill: false,
        },
        {
          label: "Falta de Suporte",
          data: [3, 5, 4, 6, 7, 8],
          borderColor: "#06063B",
          backgroundColor: "#06063B",
          fill: false,
        },
        {
          label: "Problemas Pessoais",
          data: [5, 7, 6, 5, 4, 5],
          borderColor: "#000000",
          backgroundColor: "#000000",
          fill: false,
        },
      ],
    },
    options: {
      scales: {
        y: {
          display: false,
        },
        x: {
          ticks: {
            color: "#ffffff",
          },
        },
      },
      plugins: {
        legend: {
          labels: {
            color: "#fff",
          },
        },
      },
    },
  });
</script>
