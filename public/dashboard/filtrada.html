<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/dash.css" />
    <link rel="stylesheet" href="../css/dash_prin-filt.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/sessao.js"></script>
    <link rel="icon" href="../assets/logo.png" />
    <title>Dashboard Filtrada</title>
  </head>
  <body>
    <section class="filtrada">
      <div class="menu">
        <div class="logo">
          <img src="../assets/logo.png" alt="logo infinity" />
          <h2 style="font-weight: lighter">
            INFINITY <b style="font-weight: normal">SOLUTIONS</b>
          </h2>
        </div>
        <div class="opcoes">
          <a href="./dashboard.html">PRINCIPAL</a>
          <a href="./filtrada.html">FILTRADA</a>
          <a href="./relatorio_ia.html">RELATÓRIOS</a>
          <a href="./dash_cadastro.html">CADASTRO</a>
          <a href="./cad_turmas.html">TURMAS</a>
          <span class="help">
            <a href="./edit_perfil.html">CONFIGURAÇÕES</a>
            <a href="#">SUPORTE</a>
          </span>
          <a onclick="sair()">ENCERRAR SESSÃO</a>
        </div>
      </div>
      <div class="selecao-filtrada" id="dash_pesquisa">
        <div class="content">
          <div class="container-ft">
            <span class="dados-pesquisa">
              <div class="tela-pesq">
                <h2>FILTRE DADOS DE UM CURSO:</h2>
                <div class="pesquisa">
                  <input
                    type="text"
                    id="busca_curso"
                    onkeyup="filtrarCursos()"
                  />
                  <button onclick="selecionarCurso()">BUSCAR</button>
                </div>
                <div class="cursos-listados">
                  <div id="resultados"></div>
                </div>
              </div>
            </span>
          </div>
        </div>
      </div>
      <div class="content" id="dash_filtrada">
        <div class="navdash">
          <span class="titulo">
            <span class="voltar-pesquisa" onclick="limparFiltros()"> < </span>
            DADOS SOBRE O CURSO DE <b id="nome_curso"></b>
          </span>
        </div>
        <div class="container-ft">
          <div class="superior-filtrada">
            <div class="kpis-ft">
              <div class="box-kpi-ft" style="margin-top: 50px">
                <div class="kpi-sup">
                  <span class="left">
                    <p>Turno Do Curso</p>
                    <h3 id="tmaior_evasao"></h3>
                  </span>
                  <span class="right">
                    <p id="qt_matriculas_turno"></p>
                    <h3 id="pc_matriculas_turno"></h3>
                  </span>
                </div>
                <div class="kpi-inf">
                  <span class="left">
                    <p>Modalidade Do Curso</p>
                    <h3 id="mmaior_evasao"></h3>
                  </span>
                  <span class="right">
                    <p id="qt_matriculas_modalidade"></p>
                    <h3 id="pc_matriculas_modalidade"></h3>
                  </span>
                </div>
              </div>
            </div>
            <div class="descricao">
              <p>
                Atualmente, você tem <b id="qt_alunos"></b> matriculados no
                curso de <b id="nm_curso"></b>, totalizando
                <b id="qt_turmas"></b>, divido em turnos por
                <b id="qt_matutino">4 matutinos</b>,
                <b id="qt_vespertino">1 vespertino</b> e
                <b id="qt_noturno">8 noturnos</b>, sendo
                <b id="qt_online"></b> e <b id="qt_presencial"></b>. Este é o
                <b id="ps_evasao"></b>, representando cerca de
                <b id="pc_matriculas"></b>. <br />
                Analise os dados de evasão desse curso com os gráficos abaixo!
              </p>
            </div>
          </div>
          <div class="inferior-filtrada">
            <div class="box-inf">
              <h2>MODALIDADE</h2>
              <div class="grafico-ft">
                <span class="chartInside">
                  <canvas
                    width="100"
                    height="100"
                    id="graficoModalidade"
                  ></canvas>
                </span>
              </div>
            </div>
            <div class="box-inf" id="mensalidade">
              <h2>MENSALIDADE <div class="selecao-mensalidade"><span onclick="voltar()"> < </span> <span onclick="avancar()"> > </span></div></h2>
              <div class="grafico-ft">
                <span class="chartInside">
                  <canvas id="graficoMensalidade"></canvas>
                </span>
              </div>
            </div>
            <div class="box-inf">
              <h2>TURNO</h2>
              <div class="grafico-ft">
                <span class="chartInside">
                  <canvas id="graficoTurno"></canvas>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </body>
</html>

<script>
  let cursos = [];
  let graficoModalidade;
  let graficoTurno;
  let cursoAtual = null;
  const idInstituicao = sessionStorage.FKCODIGO_INSTITUICAO;
  document.getElementById("dash_pesquisa").style.display = "none";
  document.getElementById("dash_filtrada").style.display = "flex";

  function buscarCursos() {
    if (!idInstituicao) {
      console.error("ID da instituição não definida");
      return;
    }

    fetch(`/cursos/buscarCursosPorUnidade/${idInstituicao}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then(function (resposta) {
        if (resposta.ok) {
          return resposta.json();
        } else {
          throw new Error("Houve um erro ao tentar trazer o resultado");
        }
      })
      .then(function (data) {
        if (data.length === 0) {
          console.warn("Nenhum resultado encontrado");
          return;
        }
    
        // Salva o array completo de cursos e exibe eles
        cursos = data; 
        exibirCursos(cursos); 
        console.log(data);
      })
      .catch(function (erro) {
        console.error(`#ERRO: ${erro}`);
      });
  }

  buscarCursos();

  function filtrarCursos() {
    const input = document.getElementById("busca_curso").value.toLowerCase();
    const cursosFiltrados = cursos.filter((curso) =>
      curso.nome_curso.toLowerCase().includes(input)
    );

    exibirCursos(cursosFiltrados);
  }

  function exibirCursos(listaCursos) {
    const divResultados = document.getElementById("resultados");
    divResultados.innerHTML = "";

    if (listaCursos.length === 0) {
      divResultados.innerHTML = "<p>Nenhum curso encontrado.</p>";
      return;
    }

    // Cria uma lista de cursos
    listaCursos.forEach((curso) => {
      divResultados.innerHTML += `
      <p onclick="listarCurso('${curso.nome_curso}')">${curso.nome_curso}</p>
      <hr id="linha-curso">`;
    });
  }

  function listarCurso(nomeCurso) {
    document.getElementById("busca_curso").value = nomeCurso;
    console.log("Curso selecionado:", nomeCurso);
  }

  function selecionarCurso() {
    cursoAtual = busca_curso.value.trim()
      ? busca_curso.value.trim().charAt(0).toUpperCase() +
        busca_curso.value.trim().slice(1).toLowerCase()
      : "";

    if (cursoAtual == "") {
      console.log("Nenhum curso foi selecionado");
      return false;
    }

    // Busca primeiro dados daquele curso
    fetch(`/turmas/buscarTurmasFiltradas/${idInstituicao}/${cursoAtual}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then(function (resposta) {
        if (resposta.ok) {
          return resposta.json();
        } else {
          throw new Error("Houve um erro ao tentar trazer o resultado");
        }
      })
      .then(function (data) {
        if (data.length === 0) {
          console.warn("Nenhum resultado encontrado");
          return;
        }

        const totalMatriculas = data[0].total_alunos_no_curso;

        document.getElementById("dash_pesquisa").style.display = "none";
        document.getElementById("dash_filtrada").style.display = "flex";
        document.getElementById("nome_curso").innerHTML = data[0].nome_curso;
        document.getElementById(
          "qt_alunos"
        ).innerHTML = `${data[0].total_alunos_no_curso} alunos`;
        document.getElementById("nm_curso").innerHTML = data[0].nome_curso;
        document.getElementById("qt_turmas").innerHTML = `${
          data[0].turmas_online + data[0].turmas_presencial
        } turmas`;
        document.getElementById(
          "qt_matutino"
        ).innerHTML = `${data[0].turmas_matutino} matutino`;
        document.getElementById(
          "qt_vespertino"
        ).innerHTML = `${data[0].turmas_vespertino} vespertino`;
        document.getElementById(
          "qt_noturno"
        ).innerHTML = `${data[0].turmas_noturno} noturno`;
        document.getElementById(
          "qt_online"
        ).innerHTML = `${data[0].turmas_online} na modalidade online (EAD)`;
        document.getElementById(
          "qt_presencial"
        ).innerHTML = `${data[0].turmas_presencial} na modalidade presencial`;

        console.log(data);

        // Depois os dados para a mensagem de indicação
        fetch(`/turmas/buscarRankingFiltrado/${idInstituicao}/${cursoAtual}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then(function (resposta) {
            if (resposta.ok) {
              return resposta.json();
            } else {
              throw new Error("Houve um erro ao tentar trazer o resultado");
            }
          })
          .then(function (data) {
            if (data.length === 0) {
              console.warn("Nenhum resultado encontrado");
              return;
            }
            document.getElementById(
              "ps_evasao"
            ).innerHTML = `${data[0].posicao_ranking}º curso com maior índice de evasão`;
            document.getElementById(
              "pc_matriculas"
            ).innerHTML = `${data[0].percentual_matriculas}% das matrículas totais`;
            console.log(data);

            // E então os dados para as KPIs
            fetch(`/turmas/buscarKPIfiltrada/${idInstituicao}/${cursoAtual}`, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then(function (resposta) {
                if (resposta.ok) {
                  return resposta.json();
                } else {
                  throw new Error("Houve um erro ao tentar trazer o resultado");
                }
              })
              .then(function (data) {
                if (data.length === 0) {
                  console.warn("Nenhum resultado encontrado");
                  return;
                }

                const matriculadosTurno = parseInt(data[0].matriculados_turno);
                const matriculadosModalidade = parseInt(
                  data[0].matriculados_modalidade
                );

                const porcentagemTurno = (
                  (matriculadosTurno / totalMatriculas) *
                  100
                ).toFixed(2);
                const porcentagemModalidade = (
                  (matriculadosModalidade / totalMatriculas) *
                  100
                ).toFixed(2);

                document.getElementById(
                  "tmaior_evasao"
                ).innerHTML = `${data[0].turno_maior_evasao}`;
                document.getElementById(
                  "qt_matriculas_turno"
                ).innerHTML = `${matriculadosTurno} matriculas`;
                document.getElementById(
                  "pc_matriculas_turno"
                ).innerHTML = `${porcentagemTurno}%`;
                document.getElementById(
                  "mmaior_evasao"
                ).innerHTML = `${data[0].modalidade_maior_evasao}`;
                document.getElementById(
                  "qt_matriculas_modalidade"
                ).innerHTML = `${matriculadosModalidade} matriculas`;
                document.getElementById(
                  "pc_matriculas_modalidade"
                ).innerHTML = `${porcentagemModalidade}%`;
                console.log(data);

                receberDadosDash(cursoAtual);
              })
              .catch(function (erro) {
                console.error(`#ERRO: ${erro}`);
              });
          })
          .catch(function (erro) {
            console.error(`#ERRO: ${erro}`);
          });
      })
      .catch(function (erro) {
        console.error(`#ERRO: ${erro}`);
      });
  }

  function limparFiltros() {
    document.getElementById("busca_curso").value = "";
    document.getElementById("dash_pesquisa").style.display = "flex";
    document.getElementById("dash_filtrada").style.display = "none";
    let cursoAtual = null;
  }

  function receberDadosDash(nomeCurso) {
    // Dados da modalidade e turno
    fetch(`/turmas/buscarDadosFiltrados/${idInstituicao}/${nomeCurso}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then(function (resposta) {
        if (resposta.ok) {
          return resposta.json();
        } else {
          throw new Error("Houve um erro ao tentar trazer o resultado");
        }
      })
      .then(function (data) {
        if (data.length === 0) {
          console.warn("Nenhum resultado encontrado");
          return;
        }

        atualizarDashboards(data);
        console.log(data);
      })
      .catch(function (erro) {
        console.error(`#ERRO: ${erro}`);
      });
  }

  function processarDados(data) {
    if (Array.isArray(data) && data.length > 0) {
      data = data[0];
    } else {
      console.error("Dados inválidos recebidos:", data);
      return null;
    }

    console.log("Dados recebidos para processamento:", data);

    const matriculasOnline = parseInt(data.matriculas_online, 10);
    const matriculasPresencial = parseInt(data.matriculas_presencial, 10);
    const totalOnline = data.total_online;
    const totalPresencial = data.total_presencial;

    const matriculasMatutino = parseInt(data.matriculas_matutino, 10);
    const matriculasVespertino = parseInt(data.matriculas_vespertino, 10);
    const matriculasNoturno = parseInt(data.matriculas_noturno, 10);
    const totalMatutino = data.total_matutino;
    const totalVespertino = data.total_vespertino;
    const totalNoturno = data.total_noturno;

    const totalMatriculas = matriculasOnline + matriculasPresencial;

    console.log("Total matriculas:", totalMatriculas);

    const porcentagemOnline = (
      (matriculasOnline / totalMatriculas) *
      100
    ).toFixed(2);
    const porcentagemPresencial = (
      (matriculasPresencial / totalMatriculas) *
      100
    ).toFixed(2);

    const porcentagemMatutino = (
      (matriculasMatutino / totalMatriculas) *
      100
    ).toFixed(2);
    const porcentagemVespertino = (
      (matriculasVespertino / totalMatriculas) *
      100
    ).toFixed(2);
    const porcentagemNoturno = (
      (matriculasNoturno / totalMatriculas) *
      100
    ).toFixed(2);

    return {
      totalMatriculas,
      dadosModalidade: {
        porcentagens: [porcentagemOnline, porcentagemPresencial],
        matriculas: [matriculasOnline, matriculasPresencial],
        turmas: [totalOnline, totalPresencial],
      },
      dadosTurnos: {
        porcentagens: [
          porcentagemMatutino,
          porcentagemVespertino,
          porcentagemNoturno,
        ],
        matriculas: [
          matriculasMatutino,
          matriculasVespertino,
          matriculasNoturno,
        ],
        turmas: [totalMatutino, totalVespertino, totalNoturno],
      },
    };
  }

  function atualizarDashboards(data) {
    const dadosProcessados = processarDados(data);
    if (!dadosProcessados) {
      console.error("Não foi possível processar os dados.");
      return;
    }

    // Gráfico de Barras (Modalidade)
    const ctxModalidade = document.getElementById("graficoModalidade");
    if (!ctxModalidade) {
      console.error("Elemento 'graficoModalidade' não encontrado no DOM.");
      return;
    }

    const ctxModalidadeCtx = ctxModalidade.getContext("2d");
    if (!graficoModalidade) {
      console.log("Criando gráfico de barras (Modalidade)...");
      graficoModalidade = new Chart(ctxModalidadeCtx, {
        type: "bar",
        data: {
          labels: ["Online", "Presencial"],
          datasets: [
            {
              label: `Alunos matriculados (%)`,
              data: dadosProcessados.dadosModalidade.porcentagens,
              backgroundColor: ["#270091", "#3F00EC"],
            },
          ],
        },
        options: {
          scales: {
            y: {
              ticks: { display: false },
              grid: { display: false },
            },
            x: {
              ticks: { color: "#ffffff" },
            },
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (tooltipItem) {
                  const index = tooltipItem.dataIndex;
                  const modalidades = ["Online", "Presencial"];

                  const matriculas =
                    dadosProcessados.dadosModalidade.matriculas;
                  const porcentagens =
                    dadosProcessados.dadosModalidade.porcentagens;
                  const turmas = dadosProcessados.dadosModalidade.turmas;

                  const modalidadeAtual = modalidades[index];
                  const matriculasAtuais = matriculas[index];
                  const porcentagemAtual = porcentagens[index];
                  const turmasAtuais = turmas[index];

                  return `Matriculas: ${matriculasAtuais} (${porcentagemAtual}%) | ${turmasAtuais} Turmas`;
                },
              },
            },
          },
        },
      });
    } else {
      console.log("Atualizando gráfico de barras (Modalidade)...");
      graficoModalidade.data.datasets[0].data =
        dadosProcessados.dadosModalidade.porcentagens;
      graficoModalidade.update();
    }

    // Gráfico Donut (Turno)
    const ctxTurno = document.getElementById("graficoTurno");
    if (!ctxTurno) {
      console.error("Elemento 'graficoTurno' não encontrado no DOM.");
      return;
    }

    const ctxTurnoCtx = ctxTurno.getContext("2d");
    if (!graficoTurno) {
      console.log("📊 Criando gráfico de donut (Turno)...");
      graficoTurno = new Chart(ctxTurnoCtx, {
        type: "doughnut",
        data: {
          labels: ["Matutino", "Vespertino", "Noturno"],
          datasets: [
            {
              label: "Matrículas (%)",
              data: dadosProcessados.dadosTurnos.porcentagens,
              backgroundColor: ["#270091", "#3F00EC", "#020272"],
              borderWidth: 0,
            },
          ],
        },
        options: {
          plugins: {
            legend: {
              labels: { color: "#ffffff" },
            },
            tooltip: {
              callbacks: {
                label: function (tooltipItem) {
                  const index = tooltipItem.dataIndex;
                  const turnos = ["Matutino", "Vespertino", "Noturno"];

                  const matriculas = dadosProcessados.dadosTurnos.matriculas;
                  const porcentagens =
                    dadosProcessados.dadosTurnos.porcentagens;
                  const turmas = dadosProcessados.dadosTurnos.turmas;

                  const turnoAtual = turnos[index];
                  const matriculasAtuais = matriculas[index];
                  const porcentagemAtual = porcentagens[index];
                  const turmasAtuais = turmas[index];

                  return `Matriculas: ${matriculasAtuais} (${porcentagemAtual}%) | ${turmasAtuais} Turmas`;
                },
              },
            },
          },
        },
      });
    } else {
      console.log("Atualizando gráfico de donut (Turno)...");
      graficoTurno.data.datasets[0].data =
        dadosProcessados.dadosTurnos.porcentagens;
      graficoTurno.update();
    }

    console.log("Dashboards atualizados com sucesso.");
  }

  function sair() {
    limparSessao();
  }

  // // Gráfico de Barras (Modalidade)
  // const ctxModalidade = document
  //   .getElementById("graficoModalidade")
  //   .getContext("2d");
  // const graficoModalidade = new Chart(ctxModalidade, {
  //   type: "bar",
  //   data: {
  //     labels: ["Online", "Presencial"],
  //     datasets: [
  //       {
  //         label: "Turmas (%)",
  //         data: [60, 40],
  //         backgroundColor: ["#270091", "#3F00EC"],
  //       },
  //     ],
  //   },
  //   options: {
  //     scales: {
  //       y: {
  //         ticks: {
  //           display: false,
  //         },
  //         grid: {
  //           display: false,
  //         },
  //       },
  //       x: {
  //         ticks: {
  //           color: "#ffffff",
  //         },
  //       },
  //     },
  //     plugins: {
  //       legend: {
  //         display: false,
  //       },
  //     },
  //   },
  // });

  // // Gráfico Donut (Turno)
  // const ctxTurno = document.getElementById("graficoTurno").getContext("2d");
  // const graficoTurno = new Chart(ctxTurno, {
  //   type: "doughnut",
  //   data: {
  //     labels: ["Matutino", "Vespertino", "Noturno"],
  //     datasets: [
  //       {
  //         label: "Turmas (%)",
  //         data: [30, 7, 63],
  //         backgroundColor: ["#270091", "#3F00EC", "#020272"],
  //         borderWidth: 0,
  //       },
  //     ],
  //   },
  //   options: {
  //     plugins: {
  //       legend: {
  //         labels: {
  //           color: "#ffffff",
  //         },
  //       },
  //     },
  //   },
  // });

  // Gráfico de Linha (Mensalidade)
  const ctxMensalidade = document
    .getElementById("graficoMensalidade")
    .getContext("2d");
  const graficoMensalidade = new Chart(ctxMensalidade, {
    type: "line",
    data: {
      labels: ["2017", "2018", "2019"], // Anos
      datasets: [
        {
          label: "Mensalidade (R$)",
          data: [1200, 1800, 1900], // Valor para 2017
          borderColor: "#270091",
          backgroundColor: "#270091",
          fill: false,
        },
        {
          label: "Mensalidade (R$)",
          data: [1050, 2850, 8650], // Valor para 2018
          borderColor: "#3F00EC",
          backgroundColor: "#3F00EC",
          fill: false,
        },
        {
          label: "Mensalidade (R$)",
          data: [2100, 8569, 5739], // Valor para 2019
          borderColor: "#020272",
          backgroundColor: "#020272",
          fill: false,
        },
      ],
    },

    options: {
      scales: {
        y: {
          beginAtZero: true,
          display: false,
        },
        x: {
          ticks: {
            color: "#ffffff",
          },
        },
      },
      plugins: {
        legend: {
          labels: {
            color: "#fff",
          },
        },
      },
    },
  });
</script>
